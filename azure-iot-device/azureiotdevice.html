<script type="text/javascript">
    RED.nodes.registerType('azureiotdevice',{
        category: 'Azure IoT',
        color: '#00A4EF',
        defaults: {
            deviceid: {value:"", required:true},
            connectiontype: {value: "", required:true},
            authenticationmethod: {value: "", required:true},
            iothub: {value: "", required: false},
            isIotcentral: {value: false, required:false},
            scopeid: {value: "", required:false},
            enrollmenttype: {value: "", required:false},
            saskey: {value: "", required:false},
            x509certificate: {value: "", required:false},
            x509key: {value: "", required:false},
            protocol: {value: "", required:true},
            methods: {value: []},
            information: {value: []},
            gatewayHostname: {value:"", required: false},
            gatewayCertificate: {value:"", required: false}
        },
        inputs:1,
        outputs:1,
        icon: "azureiotdevice.png",
        label: function() {
            return "Azure IoT Device: " + this.deviceid;
        },
        paletteLabel: function(){
            return "Azure IoT Device";
        },
        oneditprepare: function() {
            let node = this;

            // Local files for certificates
            function updateFileUpload() {
                if ($("#node-config-input-uselocalfiles").is(':checked')) {
                    $(".device-config-input-path").show();
                    $(".device-config-input-data").hide();
                } else {
                    $(".device-config-input-data").show();
                    $(".device-config-input-path").hide();
                }
            }
            $("#node-config-input-uselocalfiles").on("click",function() {
                updateFileUpload();
            });

            // Local files for gateway certificates
            function updateGatewayFileUpload() {
                if ($("#node-config-input-gateway-uselocalfiles").is(':checked')) {
                    $(".device-config-input-gateway-path").show();
                    $(".device-config-input-gateway-data").hide();
                } else {
                    $(".device-config-input-gateway-data").show();
                    $(".device-config-input-gateway-path").hide();
                }
            }
            $("#node-config-input-gateway-uselocalfiles").on("click",function() {
                updateFileUpload();
            });

            // Enable tabbed interaction
            let tabs = RED.tabs.create({
            id: "node-input-device-tabs",
                onchange: function(tab) {
                $("#node-input-device-tabs-content")
                    .children()
                    .hide();
                $("#" + tab.id).show();
                }
            });

            tabs.addTab({
                id: "compact-device-tab-identity",
                label: this._("Device Identity")
            });

            tabs.addTab({
                id: "compact-device-tab-methods",
                label: this._("Direct Methods")
            });

            tabs.addTab({
                id: "compact-device-tab-information",
                label: this._("Device Information")
            });

            tabs.addTab({
                id: "compact-device-tab-iotedge",
                label: this._("IoT Edge Gateway")
            });

            // Start settings field defaults
            $(".iothub-row").hide();
            $(".dps-row").hide();
            $(".sas-row").hide();
            $(".x509-row").hide();

            $("#node-input-connectiontype").change(function() {
                if ($(this).val() === "constr") {
                    $(".iothub-row").show();
                    $(".dps-row").hide();
                } else if ($(this).val() === "dps") {
                    $(".iothub-row").hide();
                    $(".dps-row").show();
                }
            });

            $("#node-input-authenticationmethod").change(function() {
                if ($(this).val() === "sas") {
                    $(".sas-row").show();
                    $(".x509-row").hide();
                } else if ($(this).val() === "x509") {
                    $(".sas-row").hide();
                    $(".x509-row").show();
                }
            });

            // Direct methods
            let methodsItemCount = 0;
            if (node.methods && node.methods.length > 0) {
                methodsItemCount = node.methods.length;
                node.methods.forEach(function(element, index, array) {
                    generateMethodEntry(element, index);
                });
            }

            function generateMethodEntry(method, id) {
                let container = $("<li/>", {
                style:
                    "background: #fefefe; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"
                });
                let row = $('<div id="row' + id + '"/>').appendTo(container);

                $(
                    '<i style="color: #eee; cursor: move;" class="node-input-device-methods-handle fa fa-bars"></i>'
                ).appendTo(row);

                let nameField = $("<input/>", {
                    id: "node-input-device-methods-name" + id,
                    class: "deviceMethodName",
                    type: "text",
                    style: "margin-left:5px;width:85%;",
                    placeholder: "name"
                }).appendTo(row);

                nameField.val(method.name);

                let finalspan = $("<span/>", {
                    style: "float: right;margin-right: 10px;"
                }).appendTo(row);

                let removeMethodButton = $("<a/>", {
                href: "#",
                    id: "node-button-method-remove" + id,
                    class: "editor-button editor-button-small",
                    style: "margin-top: 7px; margin-left: 5px;"
                }).appendTo(finalspan);

                $("<i/>", { class: "fa fa-remove" }).appendTo(removeMethodButton);

                removeMethodButton.click(function() {
                    container.css({ background: "#fee" });
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-device-methods-container").append(container);
            };

            $("#node-input-device-methods-container").sortable({
                axis: "y",
                handle: ".node-input-device-methods-handle",
                cursor: "move"
            });

            $(
                "#node-input-device-methods-container .node-input-device-methods-handle"
            ).disableSelection();


            $("#node-input-device-methods-add").click(function() {
                if (!methodsItemCount || methodsItemCount < 0) {
                    methodsItemCount = 0;
                }
                generateMethodEntry({ name: "" }, methodsItemCount++); // length is every time one more than index
                $("#node-input-device-methods-container-div").scrollTop(
                    $("#node-input-device-methods-container-div").get(0).scrollHeight
                );
            });

            function switchDialogResize() {
                switchMethodsDialogResize();
                switchInformationDialogResize();
            }

            // dialog direct Methods handling
            function switchMethodsDialogResize() {
                let rows = $(
                    "#dialog-form>div:not(.node-input-device-methods-container-row)"
                );
                let height = $("#dialog-form").height();

                rows.each(function(index, row) {
                    height -= row.outerHeight(true);
                });

                let editorRow = $(
                    "#dialog-form>div.node-input-device-methods-container-row"
                );
                height -=
                parseInt(editorRow.css("marginTop")) +
                    parseInt(editorRow.css("marginBottom"));
                $("#node-input-device-methods-container-div").css(
                    "height",
                    height + "px"
                );
            }

            // Device Information
            let informationItemCount = 0;
            if (node.information && node.information.length > 0) {
                informationItemCount = node.information.length;
                node.information.forEach(function(element, index, array) {
                    generateInformationEntry(element, index);
                });
            }

            function generateInformationEntry(information, id) {
                let container = $("<li/>", {
                style:
                    "background: #fefefe; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"
                });
                let row = $('<div id="row' + id + '"/>').appendTo(container);

                $(
                    '<i style="color: #eee; cursor: move;" class="node-input-device-information-handle fa fa-bars"></i>'
                ).appendTo(row);

                let nameField = $("<input/>", {
                    id: "node-input-device-information-name" + id,
                    class: "deviceInformationName",
                    type: "text",
                    style: "margin-left:5px;width:35%;",
                    placeholder: "name"
                }).appendTo(row);

                nameField.val(information.name);

                let valueField = $("<input/>", {
                    id: "node-input-device-information-value" + id,
                    class: "deviceInformationValue",
                    type: "text",
                    style: "margin-left:5px;width:50%",
                    placeholder: "value"
                }).appendTo(row);

                valueField.val(information.value);

                let finalspan = $("<span/>", {
                    style: "float: right;margin-right: 10px;"
                }).appendTo(row);

                let removeInformationButton = $("<a/>", {
                href: "#",
                    id: "node-button-information-remove" + id,
                    class: "editor-button editor-button-small",
                    style: "margin-top: 7px; margin-left: 5px;"
                }).appendTo(finalspan);

                $("<i/>", { class: "fa fa-remove" }).appendTo(removeInformationButton);

                removeInformationButton.click(function() {
                    container.css({ background: "#fee" });
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-device-information-container").append(container);
            };

            $("#node-input-device-information-container").sortable({
                axis: "y",
                handle: ".node-input-device-information-handle",
                cursor: "move"
            });

            $(
                "#node-input-device-information-container .node-input-device-information-handle"
            ).disableSelection();


            $("#node-input-device-information-add").click(function() {
                if (!informationItemCount || informationItemCount < 0) {
                    informationItemCount = 0;
                }
                generateInformationEntry({ name: "", value: "", json: "" }, informationItemCount++); // length is every time one more than index
                $("#node-input-device-information-container-div").scrollTop(
                    $("#node-input-device-information-container-div").get(0).scrollHeight
                );
            });

            // dialog User handling
            function switchInformationDialogResize() {
                let rows = $(
                    "#dialog-form>div:not(.node-input-device-information-container-row)"
                );
                let height = $("#dialog-form").height();

                rows.each(function(index, row) {
                    height -= row.outerHeight(true);
                });

                let editorRow = $(
                    "#dialog-form>div.node-input-device-information-container-row"
                );
                height -=
                parseInt(editorRow.css("marginTop")) +
                    parseInt(editorRow.css("marginBottom"));
                $("#node-input-device-information-container-div").css(
                    "height",
                    height + "px"
                );
            }

            $("#dialog").on("dialogresize", switchDialogResize);

            $("#dialog").on("dialogopen", function(ev) {
                let size = $("#dialog").dialog("option", "sizeCache-switch");
                if (size) {
                    $("#dialog").dialog("option", "width", size.width);
                    $("#dialog").dialog("option", "height", size.height);
                    switchDialogResize();
                } else {
                    setTimeout(switchDialogResize, 10);
                }
            });

            $("#dialog").on("dialogclose", function(ev, ui) {
                $("#dialog").off("dialogresize", switchDialogResize);
            });
        },
        oneditsave: function() {
            let node = this;

            // Save the methods for this device
            let cacheMethods = $("#node-input-device-methods-container").children();
            node.methods = [];
            cacheMethods.each(function() {
                node.methods.push({
                name: $(this)
                    .find(".deviceMethodName")
                    .val()
                });
            });

            // Save the information items for this device
            let cacheInformation = $("#node-input-device-information-container").children();
            node.information = [];
            cacheInformation.each(function() {
                node.information.push({
                    name: $(this)
                        .find(".deviceInformationName")
                        .val(),
                    value: $(this)
                        .find(".deviceInformationValue")
                        .val()
                });
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="azureiotdevice">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-input-device-tabs"></ul>
    </div>
    <div id="node-input-device-tabs-content" style="min-height: 170px;">
        <div id="compact-device-tab-identity" style="display:none">
            <div class="form-row">
                <label for="node-input-deviceid"><i class="icon-tag"></i> <span>Device ID</span></label>
                <input type="text" id="node-input-deviceid" placeholder="%deviceId%">
            </div>
            <div class="form-row">
                <label for="node-input-connectiontype"><i class="icon-tag"></i> <span>Connection Type</span></label>
                <select id="node-input-connectiontype">
                    <option value="constr">Connection string</option>
                    <option value="dps">Device provisioning service</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-authenticationmethod"><i class="icon-tag"></i> <span>Authentication Method</span></label>
                <select id="node-input-authenticationmethod">
                    <option value="sas">Shared access signature (SAS)</option>
                    <option value="x509">Certificates (X.509)</option>
                </select>
            </div>
            <div class="form-row iothub-row">
                <label for="node-input-iothub"><i class="icon-tag"></i> <span>IoT Hub Hostname</span></label>
                <input type="text" id="node-input-iothub" placeholder="%iothubname%.azure-devices.net">
            </div>
            <div class="form-row dps-row">
                <label for="node-input-isIotcentral"><i class="icon-tag"></i> <span>IoT Central Device</span></label>
                <input type="checkbox" id="node-input-isIotcentral" style="max-width:30px">
            </div>
            <div class="form-row dps-row">
                <label for="node-input-scopeid"><i class="icon-tag"></i> <span>Scope ID</span></label>
                <input type="text" id="node-input-scopeid" placeholder="%scopeId%">
            </div>
            <div class="form-row dps-row">
                <label for="node-input-enrollmenttype"><i class="icon-tag"></i> <span>Enrollment type</span></label>
                <select id="node-input-enrollmenttype">
                    <option value="group">Group</option>
                    <option value="device">Individual</option>
                </select>
            </div>
            <div class="form-row sas-row">
                <label for="node-input-saskey"><i class="icon-tag"></i> <span>SAS Key</span></label>
                <input type="password" id="node-input-saskey" placeholder="%primairy or secundairy key%">
            </div>
            <div class="form-row x509-row" class="hide" id="node-config-row-uselocalfiles">
                <input type="checkbox" id="node-config-input-uselocalfiles" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-uselocalfiles" style="width: 70%;">Use local files?</label>
            </div>
            <div class="form-row x509-row">
                <label for="node-input-x509certificate"><i class="fa fa-file-text-o"></i> <span>X.509 Certificate</span></label>
                <span class="device-config-input-data">
                    <label class="red-ui-button" for="node-config-input-certfile"><i class="fa fa-upload"></i> <span>Upload</span></label>
                    <input class="hide" type="file" id="node-config-input-certfile">
                    <span id="device-config-certname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
                    <button class="red-ui-button red-ui-button-small" id="device-config-button-cert-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
                </span>
                <input class="hide device-config-input-path" type="text" id="node-input-x509certificate" placeholder="%X509 certificate file%"/>
            </div>
            <div class="form-row x509-row">
                <label for="node-input-x509key"><i class="fa fa-file-text-o"></i> <span>X.509 Key</span></label>
                <span class="device-config-input-data">
                    <label class="red-ui-button" for="node-config-input-keyfile"><i class="fa fa-upload"></i> <span>Upload</span></label>
                    <input class="hide" type="file" id="node-config-input-keyfile">
                    <span id="device-config-keyname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
                    <button class="red-ui-button red-ui-button-small" id="device-config-button-key-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
                </span>
                <input class="hide device-config-input-path" type="text" id="node-input-x509key" placeholder="%X509 key file%"/>
            </div>
            <div class="form-row">
                <label for="node-input-protocol"><i class="icon-tag"></i> <span>Protocol</span></label>
                <select id="node-input-protocol">
                    <option value="amqp">AMQP</option>
                    <option value="amqpWs">AMQP_WS</option>
                    <option value="mqtt">MQTT</option>
                    <option value="mqttWs">MQTT_WS</option>
                </select>
            </div>
        </div>
        <div id="compact-device-tab-methods" style="display:none">
            <div class="form-row node-input-device-methods-container-row" style="margin-bottom: 0px;">
                <div id="node-input-device-methods-container-div"
                    style="box-sizing: border-box; border-radius: 5px;
                    height: 450px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
                    <ol id="node-input-device-methods-container" style="list-style-type:none; margin: 0;"></ol>
                </div>
            </div>
            <div class="form-row">
                <a href="#" class="editor-button editor-button-small" id="node-input-device-methods-add"
                    style="margin-top: 4px;"><i class="fa fa-plus"></i>
                <span data-i18n="methods-addButton"></span></a>
            </div>
        </div>
        <div id="compact-device-tab-information" style="display:none">
            <div class="form-row node-input-device-information-container-row" style="margin-bottom: 0px;">
                <div id="node-input-device-information-container-div"
                    style="box-sizing: border-box; border-radius: 5px;
                    height: 450px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
                    <ol id="node-input-device-information-container" style="list-style-type:none; margin: 0;"></ol>
                </div>
            </div>
            <div class="form-row">
                <a href="#" class="editor-button editor-button-small" id="node-input-device-information-add"
                    style="margin-top: 4px;"><i class="fa fa-plus"></i>
                <span data-i18n="information-addButton"></span></a>
            </div>
        </div>
        <div id="compact-device-tab-iotedge" style="display:none">
            <div class="form-row x509-row" class="hide" id="node-config-row-gateway-uselocalfiles">
                <input type="checkbox" id="node-config-input-gateway-uselocalfiles" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-gateway-uselocalfiles" style="width: 70%;">Use local files?</label>
            </div>
            <div class="form-row">
                <label for="node-input-gatewayHostname"><i class="icon-tag"></i> <span>Hostname</span></label>
                <input type="text" id="node-input-gatewayHostname" placeholder="%IoT Edge Hostname%">
                <label for="node-input-gatewayCertificate"><i class="fa fa-file-text-o"></i> <span>Gateway Certificate</span></label>
                <input type="text" id="node-input-gatewayCertificate" placeholder="%IoT Edge X.509 Certificate%">
            </div>
            <div class="form-row x509-row">
                <label for="node-input-gatewayCertificate"><i class="fa fa-file-text-o"></i> <span>X.509 Gateway CA Certificate</span></label>
                <span class="device-config-input-gateway-data">
                    <label class="red-ui-button" for="node-config-input-certfile"><i class="fa fa-upload"></i> <span>Upload</span></label>
                    <input class="hide" type="file" id="node-config-input-gatewayCertfile">
                    <span id="device-config-gatewayCertname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
                    <button class="red-ui-button red-ui-button-small" id="device-config-button-gatewaycert-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
                </span>
                <input class="hide device-config-input-gateway-path" type="text" id="node-input-gatewayCertificate" placeholder="%X509 certificate file%"/>
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="azureiotdevice">
    <p>The Azure IoT Device node enables you to send telemetry and properties to, and receive settings and commands from the Azure IoT platform using Node-Red. The payload requires to have a certain structure.</p>
    <p>How to use this node is documented on the github page: .... </p>
</script>